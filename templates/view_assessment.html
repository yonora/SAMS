{% extends 'base.html' %}

{% block title %}{{assessment[1]}}{% endblock %}

{% block content %}
<div class="card m-auto" style="width: 70%;">
    <h4 class="card-header text-bold text-center">
        {{assessment[2]}}
    </h4>
    <div class="card-body d-flex flex-row justify-content-between">
        <div class="d-flex flex-column w-50 ms-2">
            <label for="student_id" class="col-form-label me-3">Student ID:</label>
            <div>
                <input type="text" class="form-control" id="student_id" name="student_id" value="{{student[2]}}" readonly>
            </div>
        </div>
        <div class="d-flex flex-column w-50 ms-2">
            <label for="year_section" class="col-form-label me-3">Year and Section:</label>
            <div>
                <input type="text" class="form-control" id="year_section" name="year_section" value="{{student[1]}}" readonly>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Multiple Choice -->
        {% set multiple_choice = items | selectattr("type", "equalto", "Multiple Choice") | list %}
        {% set score = response | selectattr("5", "equalto", 1) | list | length %}
        {% if multiple_choice %}
            <h5 class="card-title mb-3">MULTIPLE CHOICE</h5>
            {% for item in multiple_choice %}
            {% set answer = response | selectattr("2", "equalto", item['id']) | first %}
            {% set color = '' if answer[5] is none else 'bg-success-subtle' if answer[5] else 'bg-danger-subtle' %}
            <div class="d-flex flex-column p-3 rounded mb-2 {{color}}">
                <h6 class="text-bold"><span>{{loop.index~'.'}}</span> {{ item['question'] }}</h6>
                {% for choice in item['choice'] %}
                <div class="d-flex flex-row">
                    <input type="radio" id="{{'choices'~loop.index}}" name="answer_{{ item['id'] }}" value="{{choice}}" {% if answer[1] == choice %}checked{% endif %} class="form-check-input me-2" disabled>
                    <label for="{{'choices'~loop.index}}" class="form-check-label">{{ choice }}</label>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        {% endif %}
        {% set identification = items | selectattr("type", "equalto", "Identification") | list %}
        {% if identification %}
            <h5 class="card-title mb-3">IDENTIFICATION</h5>
        {% for item in identification %}
        {% set answer = response | selectattr("2", "equalto", item['id']) | first %}
        {% set color = '' if answer[5] is none else 'bg-success-subtle' if answer[5] else 'bg-danger-subtle' %}
        <div class="d-flex flex-column p-3 rounded mb-2 {{color}}">
            <div class="d-flex justify-content-between">
                <h6 class="text-bold"><span>{{loop.index~'.'}}</span> {{ item['question'] }}</h6>
                {% if current_user.is_authenticated %}
                <div class="d-flex">
                    <button onclick="check(event, {{item['id']}})" data-student_id="{{answer[3]}}" class="btn btn-link text-success"><i class="bi bi-check fs-2"></i></button>
                    <button onclick="uncheck(event, {{item['id']}})" data-student_id="{{answer[3]}}" class="btn btn-link text-danger"><i class="bi bi-x fs-3"></i></button>
                </div>
                {% endif %}
            </div>
            <input type="text" name="answer_{{ item['id'] }}" class="form-control bg-transparent border border-black" value="{{answer[1]}}" readonly>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    <div class="card-footer d-flex flex-column justify-content-center">
        <h5 class="card-title mb-3">
            SCORE {% if response | selectattr("5", "equalto", none) | list | length > 0 %}(Partial){% endif %}: 
            <span>{{score}}</span>
        </h5>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function check(event, item_id)
    {
        const button = event.currentTarget;
        const student_id = event.currentTarget.dataset.student_id;
        fetch('/item/'+ item_id +'/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'correct',
                student_id: student_id
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status == 'success'){
                button.classList.add('hidden');
                button.nextElementSibling.classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function uncheck(event, item_id)
    {
        const button = event.currentTarget;
        const student_id = event.currentTarget.dataset.student_id;
        fetch('/item/'+ item_id +'/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'wrong',
                student_id: student_id
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status == 'success'){
                button.classList.add('hidden');
                button.previousElementSibling.classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}